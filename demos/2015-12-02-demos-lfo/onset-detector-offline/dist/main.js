'use strict';

var _Array$from = require('babel-runtime/core-js/array/from')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _wavesLfo = require('waves-lfo');

var _wavesLfo2 = _interopRequireDefault(_wavesLfo);

var _wavesUi = require('waves-ui');

var _wavesUi2 = _interopRequireDefault(_wavesUi);

var _wavesLoaders = require('waves-loaders');

var _wavesLoaders2 = _interopRequireDefault(_wavesLoaders);

var ctx = new AudioContext();
var loader = new _wavesLoaders2['default'].AudioBufferLoader();
loader.load('./assets/drum-loop.wav').then(run);

function run(buffer) {
  // GLOBALS
  var waveformData = [];
  var markerData = [];
  var duration = buffer.duration;

  var source = new _wavesLfo2['default'].sources.AudioInBuffer({
    ctx: ctx,
    src: buffer,
    timeType: 'relative'
  });

  var framer = new _wavesLfo2['default'].operators.Framer({
    frameSize: 512
  });

  var minMax = new _wavesLfo2['default'].operators.MinMax();

  var waveform = new _wavesLfo2['default'].sinks.Waveform({
    duration: duration,
    canvas: document.querySelector('#canvas-1'),
    color: 'steelblue'
  });

  source.connect(framer);
  framer.connect(minMax);
  minMax.connect(waveform);

  // moving average 1
  var longMovingAverage = new _wavesLfo2['default'].operators.MovingAverage({ order: 30 });
  // moving average 2
  var shortMovingAverage = new _wavesLfo2['default'].operators.MovingAverage({ order: 10 });

  // difference
  var counter = 0;
  var stack = [];
  var diff = new _wavesLfo2['default'].operators.Noop();

  diff.process = function (time, frame, metaData) {
    var frameSize = this.outFrame.length;
    stack[counter] = frame;

    if (counter === 1) {
      for (var i = 0; i < frameSize; i++) {
        this.outFrame[i] = stack[1][i] - stack[0][i];
      }

      this.time = time;

      // reset
      stack.length = 0;
      this.output();
    }

    counter = (counter + 1) % 2;
  };

  var maxOptions = {
    frameSize: 1,
    type: 'vector',
    onProcess: function onProcess(time, frame, outFrame) {
      var max = -Infinity;
      var value = undefined;

      for (var i = 0, l = frame.length; i < l; i++) {
        value = frame[i];
        if (value > max) {
          max = value;
        }
      }

      outFrame[0] = max;
    }
  };

  var maxMA1 = new _wavesLfo2['default'].operators.Operator(maxOptions);
  var bpfMA1 = new _wavesLfo2['default'].sinks.Bpf({
    canvas: document.querySelector('#canvas-3'),
    duration: duration
  });

  var maxMA2 = new _wavesLfo2['default'].operators.Operator(maxOptions);
  var bpfMA2 = new _wavesLfo2['default'].sinks.Bpf({
    canvas: document.querySelector('#canvas-4'),
    duration: duration
  });

  // get max value from each frames
  var max = new _wavesLfo2['default'].operators.Operator(maxOptions);

  var bpf = new _wavesLfo2['default'].sinks.Bpf({
    canvas: document.querySelector('#canvas-2'),
    duration: duration
  });

  var $onset = document.querySelector('#onset');
  var $timestamps = document.querySelector('#timestamps');
  var threshold = 0.04;
  var active = false;

  // log all new onsets
  var logger = new _wavesLfo2['default'].operators.Noop();
  logger.process = function (time, frame) {
    if (frame[0] > threshold) {
      if (!active) {
        active = true;
        $onset.classList.add('active');
        $timestamps.innerHTML = '<p>' + time + '</p>' + $timestamps.innerHTML;
        // update markers
        markerData.push({ time: time });
      }
    } else {
      active = false;
      $onset.classList.remove('active');
    }
  };

  source.connect(longMovingAverage);
  source.connect(shortMovingAverage);

  longMovingAverage.connect(diff);
  shortMovingAverage.connect(diff);

  longMovingAverage.connect(maxMA1);
  maxMA1.connect(bpfMA1);

  shortMovingAverage.connect(maxMA2);
  maxMA2.connect(bpfMA2);

  diff.connect(max);
  max.connect(bpf);
  max.connect(logger);

  // UI PART
  var displayedDuration = duration;
  var width = 800;
  var pixelsPerSecond = width / displayedDuration;

  var timeline = new _wavesUi2['default'].core.Timeline(pixelsPerSecond, width);
  timeline.createTrack(document.querySelector('#axis'), 16, 'axis');
  timeline.createTrack(document.querySelector('#track'), 200, 'main');

  var axis = new _wavesUi2['default'].helpers.TimeAxisLayer();
  timeline.addLayer(axis, 'axis', 'default', true);

  var waveformLayer = new _wavesUi2['default'].core.Layer('entity', waveformData, {
    height: 200,
    sampleRate: ctx.sampleRate,
    yDomain: [-1, 1]
  });

  waveformLayer.setTimeContext(new _wavesUi2['default'].core.LayerTimeContext(timeline.timeContext));
  waveformLayer.configureShape(_wavesUi2['default'].shapes.Waveform, {
    y: function y(d) {
      return d;
    }
  }, {
    color: 'steelblue'
  });

  var markerLayer = new _wavesUi2['default'].helpers.MarkerLayer(markerData, {
    height: 200,
    displayHandlers: false
  }, {
    color: function color() {
      return 'red';
    },
    x: function x(d) {
      return d.time;
    }
  });

  timeline.addLayer(waveformLayer, 'main');
  timeline.addLayer(markerLayer, 'main');

  timeline.state = new _wavesUi2['default'].states.CenteredZoomState(timeline);

  timeline.tracks.render();

  // lfo to append values to the data of the waveform
  var appender = new _wavesLfo2['default'].operators.Noop();
  appender.process = function (time, frame) {
    Array.prototype.push.apply(waveformData, _Array$from(frame.values()));
  };

  source.connect(appender);

  var rAFId = undefined;
  // update waveformLayer
  function loop() {
    var bufferDuration = waveformData.length / ctx.sampleRate;

    if (bufferDuration > displayedDuration) {
      var decayTime = bufferDuration - displayedDuration;

      timeline.offset = -decayTime;
      waveformLayer.duration = bufferDuration;
      markerLayer.duration = bufferDuration;
    }

    timeline.tracks.render();
    timeline.tracks.update();

    rAFId = requestAnimationFrame(loop);
  };

  function reset() {
    timeline.offset = 0;
    timeline.zoom = 1;
    waveformLayer.duration = displayedDuration;
    markerLayer.duration = displayedDuration;
    waveformData.length = 0;
    markerData.length = 0;
    $timestamps.innerHTML = '';
  }

  // controls
  var $start = document.querySelector('#start');
  $start.addEventListener('click', function (e) {
    // reset timeline
    reset();
    loop();

    source.start();
  });

  var $stop = document.querySelector('#stop');
  $stop.addEventListener('click', function (e) {
    source.stop();
    cancelAnimationFrame(rAFId);
  });
}
//# sourceMappingURL=data:application/json;base64,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QUFDO0FBQ3hCLGNBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLGVBQVcsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO0dBQzVCOzs7QUFHRCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2hELFFBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsVUFBUyxDQUFDLEVBQUU7O0FBRTNDLFNBQUssRUFBRSxDQUFDO0FBQ1IsUUFBSSxFQUFFLENBQUM7O0FBRVAsVUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO0dBQ2hCLENBQUMsQ0FBQzs7QUFFSCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzlDLE9BQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsVUFBUyxDQUFDLEVBQUU7QUFDMUMsVUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2Qsd0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7R0FDN0IsQ0FBQyxDQUFDO0NBQ0oiLCJmaWxlIjoiZXM2L21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbGZvIGZyb20gJ3dhdmVzLWxmbyc7XG5pbXBvcnQgdWkgZnJvbSAnd2F2ZXMtdWknO1xuaW1wb3J0IGxvYWRlcnMgZnJvbSAnd2F2ZXMtbG9hZGVycyc7XG5cbmNvbnN0IGN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTtcbmNvbnN0IGxvYWRlciA9IG5ldyBsb2FkZXJzLkF1ZGlvQnVmZmVyTG9hZGVyKCk7XG5sb2FkZXIubG9hZCgnLi9hc3NldHMvZHJ1bS1sb29wLndhdicpLnRoZW4ocnVuKTtcblxuZnVuY3Rpb24gcnVuKGJ1ZmZlcikge1xuICAvLyBHTE9CQUxTXG4gIGNvbnN0IHdhdmVmb3JtRGF0YSA9IFtdO1xuICBjb25zdCBtYXJrZXJEYXRhID0gW107XG4gIGNvbnN0IGR1cmF0aW9uID0gYnVmZmVyLmR1cmF0aW9uO1xuXG4gIGNvbnN0IHNvdXJjZSA9IG5ldyBsZm8uc291cmNlcy5BdWRpb0luQnVmZmVyKHtcbiAgICBjdHg6IGN0eCxcbiAgICBzcmM6IGJ1ZmZlcixcbiAgICB0aW1lVHlwZTogJ3JlbGF0aXZlJyxcbiAgfSk7XG5cbiAgY29uc3QgZnJhbWVyID0gbmV3IGxmby5vcGVyYXRvcnMuRnJhbWVyKHtcbiAgICBmcmFtZVNpemU6IDUxMixcbiAgfSk7XG5cbiAgY29uc3QgbWluTWF4ID0gbmV3IGxmby5vcGVyYXRvcnMuTWluTWF4KCk7XG5cbiAgY29uc3Qgd2F2ZWZvcm0gPSBuZXcgbGZvLnNpbmtzLldhdmVmb3JtKHtcbiAgICBkdXJhdGlvbjogZHVyYXRpb24sXG4gICAgY2FudmFzOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjY2FudmFzLTEnKSxcbiAgICBjb2xvcjogJ3N0ZWVsYmx1ZScsXG4gIH0pO1xuXG4gIHNvdXJjZS5jb25uZWN0KGZyYW1lcik7XG4gIGZyYW1lci5jb25uZWN0KG1pbk1heCk7XG4gIG1pbk1heC5jb25uZWN0KHdhdmVmb3JtKTtcblxuICAvLyBtb3ZpbmcgYXZlcmFnZSAxXG4gIGNvbnN0IGxvbmdNb3ZpbmdBdmVyYWdlID0gbmV3IGxmby5vcGVyYXRvcnMuTW92aW5nQXZlcmFnZSh7IG9yZGVyOiAzMCB9KTtcbiAgLy8gbW92aW5nIGF2ZXJhZ2UgMlxuICBjb25zdCBzaG9ydE1vdmluZ0F2ZXJhZ2UgPSBuZXcgbGZvLm9wZXJhdG9ycy5Nb3ZpbmdBdmVyYWdlKHsgb3JkZXI6IDEwIH0pO1xuXG4gIC8vIGRpZmZlcmVuY2VcbiAgbGV0IGNvdW50ZXIgPSAwO1xuICBsZXQgc3RhY2sgPSBbXTtcbiAgY29uc3QgZGlmZiA9IG5ldyBsZm8ub3BlcmF0b3JzLk5vb3AoKTtcblxuICBkaWZmLnByb2Nlc3MgPSBmdW5jdGlvbih0aW1lLCBmcmFtZSwgbWV0YURhdGEpIHtcbiAgICBjb25zdCBmcmFtZVNpemUgPSB0aGlzLm91dEZyYW1lLmxlbmd0aDtcbiAgICBzdGFja1tjb3VudGVyXSA9IGZyYW1lO1xuXG4gICAgaWYgKGNvdW50ZXIgPT09IDEpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVTaXplOyBpKyspIHtcbiAgICAgICAgdGhpcy5vdXRGcmFtZVtpXSA9IHN0YWNrWzFdW2ldIC0gc3RhY2tbMF1baV07XG4gICAgICB9XG5cbiAgICAgIHRoaXMudGltZSA9IHRpbWU7XG5cbiAgICAgIC8vIHJlc2V0XG4gICAgICBzdGFjay5sZW5ndGggPSAwO1xuICAgICAgdGhpcy5vdXRwdXQoKTtcbiAgICB9XG5cbiAgICBjb3VudGVyID0gKGNvdW50ZXIgKyAxKSAlIDI7XG4gIH1cblxuICBjb25zdCBtYXhPcHRpb25zID0ge1xuICAgIGZyYW1lU2l6ZTogMSxcbiAgICB0eXBlOiAndmVjdG9yJyxcbiAgICBvblByb2Nlc3M6IGZ1bmN0aW9uKHRpbWUsIGZyYW1lLCBvdXRGcmFtZSkge1xuICAgICAgbGV0IG1heCA9IC1JbmZpbml0eTtcbiAgICAgIGxldCB2YWx1ZTtcblxuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBmcmFtZS5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgdmFsdWUgPSBmcmFtZVtpXTtcbiAgICAgICAgaWYgKHZhbHVlID4gbWF4KSB7IG1heCA9IHZhbHVlOyB9XG4gICAgICB9XG5cbiAgICAgIG91dEZyYW1lWzBdID0gbWF4O1xuICAgIH1cbiAgfTtcblxuICBjb25zdCBtYXhNQTEgPSBuZXcgbGZvLm9wZXJhdG9ycy5PcGVyYXRvcihtYXhPcHRpb25zKTtcbiAgY29uc3QgYnBmTUExID0gbmV3IGxmby5zaW5rcy5CcGYoe1xuICAgIGNhbnZhczogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NhbnZhcy0zJyksXG4gICAgZHVyYXRpb246IGR1cmF0aW9uLFxuICB9KTtcblxuICBjb25zdCBtYXhNQTIgPSBuZXcgbGZvLm9wZXJhdG9ycy5PcGVyYXRvcihtYXhPcHRpb25zKTtcbiAgY29uc3QgYnBmTUEyID0gbmV3IGxmby5zaW5rcy5CcGYoe1xuICAgIGNhbnZhczogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NhbnZhcy00JyksXG4gICAgZHVyYXRpb246IGR1cmF0aW9uLFxuICB9KTtcblxuXG4gIC8vIGdldCBtYXggdmFsdWUgZnJvbSBlYWNoIGZyYW1lc1xuICBjb25zdCBtYXggPSBuZXcgbGZvLm9wZXJhdG9ycy5PcGVyYXRvcihtYXhPcHRpb25zKTtcblxuICBjb25zdCBicGYgPSBuZXcgbGZvLnNpbmtzLkJwZih7XG4gICAgY2FudmFzOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjY2FudmFzLTInKSxcbiAgICBkdXJhdGlvbjogZHVyYXRpb24sXG4gIH0pO1xuXG4gIGNvbnN0ICRvbnNldCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNvbnNldCcpO1xuICBjb25zdCAkdGltZXN0YW1wcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyN0aW1lc3RhbXBzJyk7XG4gIGNvbnN0IHRocmVzaG9sZCA9IDAuMDQ7XG4gIGxldCBhY3RpdmUgPSBmYWxzZTtcblxuICAvLyBsb2cgYWxsIG5ldyBvbnNldHNcbiAgY29uc3QgbG9nZ2VyID0gbmV3IGxmby5vcGVyYXRvcnMuTm9vcCgpO1xuICBsb2dnZXIucHJvY2VzcyA9IGZ1bmN0aW9uKHRpbWUsIGZyYW1lKSB7XG4gICAgaWYgKGZyYW1lWzBdID4gdGhyZXNob2xkKSB7XG4gICAgICBpZiAoIWFjdGl2ZSkge1xuICAgICAgICBhY3RpdmUgPSB0cnVlO1xuICAgICAgICAkb25zZXQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XG4gICAgICAgICR0aW1lc3RhbXBzLmlubmVySFRNTCA9ICc8cD4nICsgdGltZSArICc8L3A+JyArICR0aW1lc3RhbXBzLmlubmVySFRNTDtcbiAgICAgICAgLy8gdXBkYXRlIG1hcmtlcnNcbiAgICAgICAgbWFya2VyRGF0YS5wdXNoKHsgdGltZSB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgYWN0aXZlID0gZmFsc2U7XG4gICAgICAkb25zZXQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7XG4gICAgfVxuICB9XG5cbiAgc291cmNlLmNvbm5lY3QobG9uZ01vdmluZ0F2ZXJhZ2UpO1xuICBzb3VyY2UuY29ubmVjdChzaG9ydE1vdmluZ0F2ZXJhZ2UpO1xuXG4gIGxvbmdNb3ZpbmdBdmVyYWdlLmNvbm5lY3QoZGlmZik7XG4gIHNob3J0TW92aW5nQXZlcmFnZS5jb25uZWN0KGRpZmYpO1xuXG4gIGxvbmdNb3ZpbmdBdmVyYWdlLmNvbm5lY3QobWF4TUExKTtcbiAgbWF4TUExLmNvbm5lY3QoYnBmTUExKTtcblxuICBzaG9ydE1vdmluZ0F2ZXJhZ2UuY29ubmVjdChtYXhNQTIpO1xuICBtYXhNQTIuY29ubmVjdChicGZNQTIpO1xuXG4gIGRpZmYuY29ubmVjdChtYXgpO1xuICBtYXguY29ubmVjdChicGYpO1xuICBtYXguY29ubmVjdChsb2dnZXIpO1xuXG4gIC8vIFVJIFBBUlRcbiAgY29uc3QgZGlzcGxheWVkRHVyYXRpb24gPSBkdXJhdGlvbjtcbiAgY29uc3Qgd2lkdGggPSA4MDA7XG4gIGNvbnN0IHBpeGVsc1BlclNlY29uZCA9IHdpZHRoIC8gZGlzcGxheWVkRHVyYXRpb247XG5cbiAgY29uc3QgdGltZWxpbmUgPSBuZXcgdWkuY29yZS5UaW1lbGluZShwaXhlbHNQZXJTZWNvbmQsIHdpZHRoKTtcbiAgdGltZWxpbmUuY3JlYXRlVHJhY2soZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2F4aXMnKSwgMTYsICdheGlzJyk7XG4gIHRpbWVsaW5lLmNyZWF0ZVRyYWNrKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyN0cmFjaycpLCAyMDAsICdtYWluJyk7XG5cbiAgY29uc3QgYXhpcyA9IG5ldyB1aS5oZWxwZXJzLlRpbWVBeGlzTGF5ZXIoKTtcbiAgdGltZWxpbmUuYWRkTGF5ZXIoYXhpcywgJ2F4aXMnLCAnZGVmYXVsdCcsIHRydWUpO1xuXG4gIGNvbnN0IHdhdmVmb3JtTGF5ZXIgPSBuZXcgdWkuY29yZS5MYXllcignZW50aXR5Jywgd2F2ZWZvcm1EYXRhLCB7XG4gICAgaGVpZ2h0OiAyMDAsXG4gICAgc2FtcGxlUmF0ZTogY3R4LnNhbXBsZVJhdGUsXG4gICAgeURvbWFpbjogWy0xLCAxXSxcbiAgfSk7XG5cbiAgd2F2ZWZvcm1MYXllci5zZXRUaW1lQ29udGV4dChuZXcgdWkuY29yZS5MYXllclRpbWVDb250ZXh0KHRpbWVsaW5lLnRpbWVDb250ZXh0KSk7XG4gIHdhdmVmb3JtTGF5ZXIuY29uZmlndXJlU2hhcGUodWkuc2hhcGVzLldhdmVmb3JtLCB7XG4gICAgeTogKGQpID0+IHsgcmV0dXJuIGQ7IH1cbiAgfSwge1xuICAgIGNvbG9yOiAnc3RlZWxibHVlJyxcbiAgfSk7XG5cbiAgY29uc3QgbWFya2VyTGF5ZXIgPSBuZXcgdWkuaGVscGVycy5NYXJrZXJMYXllcihtYXJrZXJEYXRhLCB7XG4gICAgaGVpZ2h0OiAyMDAsXG4gICAgZGlzcGxheUhhbmRsZXJzOiBmYWxzZSxcbiAgfSwge1xuICAgIGNvbG9yOiAoKSA9PiB7IHJldHVybiAncmVkJzsgfSxcbiAgICB4OiAoZCkgPT4geyByZXR1cm4gZC50aW1lOyB9LFxuICB9KTtcblxuICB0aW1lbGluZS5hZGRMYXllcih3YXZlZm9ybUxheWVyLCAnbWFpbicpO1xuICB0aW1lbGluZS5hZGRMYXllcihtYXJrZXJMYXllciwgJ21haW4nKTtcblxuICB0aW1lbGluZS5zdGF0ZSA9IG5ldyB1aS5zdGF0ZXMuQ2VudGVyZWRab29tU3RhdGUodGltZWxpbmUpO1xuXG4gIHRpbWVsaW5lLnRyYWNrcy5yZW5kZXIoKTtcblxuICAvLyBsZm8gdG8gYXBwZW5kIHZhbHVlcyB0byB0aGUgZGF0YSBvZiB0aGUgd2F2ZWZvcm1cbiAgY29uc3QgYXBwZW5kZXIgPSBuZXcgbGZvLm9wZXJhdG9ycy5Ob29wKCk7XG4gIGFwcGVuZGVyLnByb2Nlc3MgPSBmdW5jdGlvbih0aW1lLCBmcmFtZSkge1xuICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHdhdmVmb3JtRGF0YSwgQXJyYXkuZnJvbShmcmFtZS52YWx1ZXMoKSkpO1xuICB9XG5cbiAgc291cmNlLmNvbm5lY3QoYXBwZW5kZXIpO1xuXG4gIGxldCByQUZJZDtcbiAgLy8gdXBkYXRlIHdhdmVmb3JtTGF5ZXJcbiAgZnVuY3Rpb24gbG9vcCgpIHtcbiAgICBjb25zdCBidWZmZXJEdXJhdGlvbiA9IHdhdmVmb3JtRGF0YS5sZW5ndGggLyBjdHguc2FtcGxlUmF0ZTtcblxuICAgIGlmIChidWZmZXJEdXJhdGlvbiA+IGRpc3BsYXllZER1cmF0aW9uKSB7XG4gICAgICBjb25zdCBkZWNheVRpbWUgPSBidWZmZXJEdXJhdGlvbiAtIGRpc3BsYXllZER1cmF0aW9uO1xuXG4gICAgICB0aW1lbGluZS5vZmZzZXQgPSAtZGVjYXlUaW1lO1xuICAgICAgd2F2ZWZvcm1MYXllci5kdXJhdGlvbiA9IGJ1ZmZlckR1cmF0aW9uO1xuICAgICAgbWFya2VyTGF5ZXIuZHVyYXRpb24gPSBidWZmZXJEdXJhdGlvbjtcbiAgICB9XG5cbiAgICB0aW1lbGluZS50cmFja3MucmVuZGVyKCk7XG4gICAgdGltZWxpbmUudHJhY2tzLnVwZGF0ZSgpO1xuXG4gICAgckFGSWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7XG4gIH07XG5cbiAgZnVuY3Rpb24gcmVzZXQoKSB7XG4gICAgdGltZWxpbmUub2Zmc2V0ID0gMDtcbiAgICB0aW1lbGluZS56b29tID0gMTtcbiAgICB3YXZlZm9ybUxheWVyLmR1cmF0aW9uID0gZGlzcGxheWVkRHVyYXRpb247XG4gICAgbWFya2VyTGF5ZXIuZHVyYXRpb24gPSBkaXNwbGF5ZWREdXJhdGlvbjtcbiAgICB3YXZlZm9ybURhdGEubGVuZ3RoID0gMDtcbiAgICBtYXJrZXJEYXRhLmxlbmd0aCA9IDA7XG4gICAgJHRpbWVzdGFtcHMuaW5uZXJIVE1MID0gJyc7XG4gIH1cblxuICAvLyBjb250cm9sc1xuICBjb25zdCAkc3RhcnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjc3RhcnQnKTtcbiAgJHN0YXJ0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oZSkge1xuICAgIC8vIHJlc2V0IHRpbWVsaW5lXG4gICAgcmVzZXQoKTtcbiAgICBsb29wKCk7XG5cbiAgICBzb3VyY2Uuc3RhcnQoKTtcbiAgfSk7XG5cbiAgY29uc3QgJHN0b3AgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjc3RvcCcpO1xuICAkc3RvcC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGUpIHtcbiAgICBzb3VyY2Uuc3RvcCgpO1xuICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJBRklkKTtcbiAgfSk7XG59XG5cblxuXG5cblxuXG5cblxuXG5cbiJdfQ==