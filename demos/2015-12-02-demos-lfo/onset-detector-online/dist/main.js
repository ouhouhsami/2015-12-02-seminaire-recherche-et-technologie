'use strict';

var _Array$from = require('babel-runtime/core-js/array/from')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _wavesLfo = require('waves-lfo');

var _wavesLfo2 = _interopRequireDefault(_wavesLfo);

var _wavesUi = require('waves-ui');

var _wavesUi2 = _interopRequireDefault(_wavesUi);

var _wavesLoaders = require('waves-loaders');

var _wavesLoaders2 = _interopRequireDefault(_wavesLoaders);

navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

var ctx = new AudioContext();

function run(e) {
  // GLOBALS
  var waveformData = [];
  var markerData = [];

  var audioIn = ctx.createMediaStreamSource(e);

  var source = new _wavesLfo2['default'].sources.AudioInNode({
    ctx: ctx,
    src: audioIn,
    timeType: 'relative'
  });

  var framer = new _wavesLfo2['default'].operators.Framer({
    frameSize: 512
  });

  var minMax = new _wavesLfo2['default'].operators.MinMax();

  var waveform = new _wavesLfo2['default'].sinks.Waveform({
    duration: 4,
    canvas: document.querySelector('#canvas-1'),
    color: 'steelblue'
  });

  source.connect(framer);
  framer.connect(minMax);
  minMax.connect(waveform);

  // moving average 1
  var longMovingAverage = new _wavesLfo2['default'].operators.MovingAverage({ order: 30 });
  // moving average 2
  var shortMovingAverage = new _wavesLfo2['default'].operators.MovingAverage({ order: 10 });

  // difference
  var counter = 0;
  var stack = [];
  var diff = new _wavesLfo2['default'].operators.Noop();

  diff.process = function (time, frame, metaData) {
    var frameSize = this.outFrame.length;
    stack[counter] = frame;

    if (counter === 1) {
      for (var i = 0; i < frameSize; i++) {
        this.outFrame[i] = stack[1][i] - stack[0][i];
      }

      this.time = time;

      // reset
      stack.length = 0;
      this.output();
    }

    counter = (counter + 1) % 2;
  };

  var maxOptions = {
    frameSize: 1,
    type: 'vector',
    onProcess: function onProcess(time, frame, outFrame) {
      var max = -Infinity;
      var value = undefined;

      for (var i = 0, l = frame.length; i < l; i++) {
        value = frame[i];
        if (value > max) {
          max = value;
        }
      }

      outFrame[0] = max;
    }
  };

  var maxMA1 = new _wavesLfo2['default'].operators.Operator(maxOptions);
  var bpfMA1 = new _wavesLfo2['default'].sinks.Bpf({
    canvas: document.querySelector('#canvas-3'),
    duration: 4
  });

  var maxMA2 = new _wavesLfo2['default'].operators.Operator(maxOptions);
  var bpfMA2 = new _wavesLfo2['default'].sinks.Bpf({
    canvas: document.querySelector('#canvas-4'),
    duration: 4
  });

  // get max value from each frames
  var max = new _wavesLfo2['default'].operators.Operator(maxOptions);

  var bpf = new _wavesLfo2['default'].sinks.Bpf({
    canvas: document.querySelector('#canvas-2'),
    duration: 4
  });

  var $onset = document.querySelector('#onset');
  var $timestamps = document.querySelector('#timestamps');
  var threshold = 0.04;
  var active = false;

  // log all new onsets
  var logger = new _wavesLfo2['default'].operators.Noop();
  logger.process = function (time, frame) {
    if (frame[0] > threshold) {
      if (!active) {
        active = true;
        $onset.classList.add('active');
        $timestamps.innerHTML = '<p>' + time + '</p>' + $timestamps.innerHTML;
        // update markers
        markerData.push({ time: time });
      }
    } else {
      active = false;
      $onset.classList.remove('active');
    }
  };

  source.connect(longMovingAverage);
  source.connect(shortMovingAverage);

  longMovingAverage.connect(diff);
  shortMovingAverage.connect(diff);

  longMovingAverage.connect(maxMA1);
  maxMA1.connect(bpfMA1);

  shortMovingAverage.connect(maxMA2);
  maxMA2.connect(bpfMA2);

  diff.connect(max);
  max.connect(bpf);
  max.connect(logger);

  // UI PART
  var displayedDuration = 10;
  var width = 800;
  var pixelsPerSecond = width / displayedDuration;

  var timeline = new _wavesUi2['default'].core.Timeline(pixelsPerSecond, width);
  timeline.createTrack(document.querySelector('#axis'), 16, 'axis');
  timeline.createTrack(document.querySelector('#track'), 200, 'main');

  var axis = new _wavesUi2['default'].helpers.TimeAxisLayer();
  timeline.addLayer(axis, 'axis', 'default', true);

  var waveformLayer = new _wavesUi2['default'].core.Layer('entity', waveformData, {
    height: 200,
    sampleRate: ctx.sampleRate,
    yDomain: [-1, 1]
  });

  waveformLayer.setTimeContext(new _wavesUi2['default'].core.LayerTimeContext(timeline.timeContext));
  waveformLayer.configureShape(_wavesUi2['default'].shapes.Waveform, {
    y: function y(d) {
      return d;
    }
  }, {
    color: 'steelblue'
  });

  var markerLayer = new _wavesUi2['default'].helpers.MarkerLayer(markerData, {
    height: 200,
    displayHandlers: false
  }, {
    color: function color() {
      return 'red';
    },
    x: function x(d) {
      return d.time;
    }
  });

  timeline.addLayer(waveformLayer, 'main');
  timeline.addLayer(markerLayer, 'main');

  timeline.state = new _wavesUi2['default'].states.CenteredZoomState(timeline);

  timeline.tracks.render();

  // lfo to append values to the data of the waveform
  var appender = new _wavesLfo2['default'].operators.Noop();
  appender.process = function (time, frame) {
    Array.prototype.push.apply(waveformData, _Array$from(frame.values()));
  };

  source.connect(appender);

  var rAFId = undefined;
  // update waveformLayer
  function loop() {
    var bufferDuration = waveformData.length / ctx.sampleRate;

    if (bufferDuration > displayedDuration) {
      var decayTime = bufferDuration - displayedDuration;

      timeline.offset = -decayTime;
      waveformLayer.duration = bufferDuration;
      markerLayer.duration = bufferDuration;
    }

    timeline.tracks.render();
    timeline.tracks.update();

    rAFId = requestAnimationFrame(loop);
  };

  function reset() {
    timeline.offset = 0;
    timeline.zoom = 1;
    waveformLayer.duration = displayedDuration;
    markerLayer.duration = displayedDuration;
    waveformData.length = 0;
    markerData.length = 0;
    $timestamps.innerHTML = '';
  }

  // controls
  var $start = document.querySelector('#start');
  $start.addEventListener('click', function (e) {
    // reset timeline
    reset();
    loop();

    source.start();
  });

  var $stop = document.querySelector('#stop');
  $stop.addEventListener('click', function (e) {
    source.stop();
    cancelAnimationFrame(rAFId);
  });
}

navigator.getUserMedia({ audio: true }, run, function (err) {
  console.error(err.stack);
});
//# sourceMappingURL=data:application/json;base64,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QUFHLENBQUMsQ0FBQztBQUN4QixjQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUN0QixlQUFXLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztHQUM1Qjs7O0FBR0QsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNoRCxRQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFVBQVMsQ0FBQyxFQUFFOztBQUUzQyxTQUFLLEVBQUUsQ0FBQztBQUNSLFFBQUksRUFBRSxDQUFDOztBQUVQLFVBQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztHQUNoQixDQUFDLENBQUM7O0FBRUgsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM5QyxPQUFLLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFVBQVMsQ0FBQyxFQUFFO0FBQzFDLFVBQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNkLHdCQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO0dBQzdCLENBQUMsQ0FBQztDQUNKOztBQUVELFNBQVMsQ0FBQyxZQUFZLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsR0FBRyxFQUFFLFVBQVMsR0FBRyxFQUFFO0FBQ3pELFNBQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0NBQzFCLENBQUMsQ0FBQyIsImZpbGUiOiJlczYvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsZm8gZnJvbSAnd2F2ZXMtbGZvJztcbmltcG9ydCB1aSBmcm9tICd3YXZlcy11aSc7XG5pbXBvcnQgbG9hZGVycyBmcm9tICd3YXZlcy1sb2FkZXJzJztcblxubmF2aWdhdG9yLmdldFVzZXJNZWRpYSA9IChuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhIHx8IG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgfHwgbmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSB8fCBuYXZpZ2F0b3IubXNHZXRVc2VyTWVkaWEpO1xuXG5jb25zdCBjdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7XG5cbmZ1bmN0aW9uIHJ1bihlKSB7XG4gIC8vIEdMT0JBTFNcbiAgY29uc3Qgd2F2ZWZvcm1EYXRhID0gW107XG4gIGNvbnN0IG1hcmtlckRhdGEgPSBbXTtcblxuICBjb25zdCBhdWRpb0luID0gY3R4LmNyZWF0ZU1lZGlhU3RyZWFtU291cmNlKGUpO1xuXG4gIGNvbnN0IHNvdXJjZSA9IG5ldyBsZm8uc291cmNlcy5BdWRpb0luTm9kZSh7XG4gICAgY3R4OiBjdHgsXG4gICAgc3JjOiBhdWRpb0luLFxuICAgIHRpbWVUeXBlOiAncmVsYXRpdmUnLFxuICB9KTtcblxuICBjb25zdCBmcmFtZXIgPSBuZXcgbGZvLm9wZXJhdG9ycy5GcmFtZXIoe1xuICAgIGZyYW1lU2l6ZTogNTEyLFxuICB9KTtcblxuICBjb25zdCBtaW5NYXggPSBuZXcgbGZvLm9wZXJhdG9ycy5NaW5NYXgoKTtcblxuICBjb25zdCB3YXZlZm9ybSA9IG5ldyBsZm8uc2lua3MuV2F2ZWZvcm0oe1xuICAgIGR1cmF0aW9uOiA0LFxuICAgIGNhbnZhczogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NhbnZhcy0xJyksXG4gICAgY29sb3I6ICdzdGVlbGJsdWUnLFxuICB9KTtcblxuICBzb3VyY2UuY29ubmVjdChmcmFtZXIpO1xuICBmcmFtZXIuY29ubmVjdChtaW5NYXgpO1xuICBtaW5NYXguY29ubmVjdCh3YXZlZm9ybSk7XG5cbiAgLy8gbW92aW5nIGF2ZXJhZ2UgMVxuICBjb25zdCBsb25nTW92aW5nQXZlcmFnZSA9IG5ldyBsZm8ub3BlcmF0b3JzLk1vdmluZ0F2ZXJhZ2UoeyBvcmRlcjogMzAgfSk7XG4gIC8vIG1vdmluZyBhdmVyYWdlIDJcbiAgY29uc3Qgc2hvcnRNb3ZpbmdBdmVyYWdlID0gbmV3IGxmby5vcGVyYXRvcnMuTW92aW5nQXZlcmFnZSh7IG9yZGVyOiAxMCB9KTtcblxuICAvLyBkaWZmZXJlbmNlXG4gIGxldCBjb3VudGVyID0gMDtcbiAgbGV0IHN0YWNrID0gW107XG4gIGNvbnN0IGRpZmYgPSBuZXcgbGZvLm9wZXJhdG9ycy5Ob29wKCk7XG5cbiAgZGlmZi5wcm9jZXNzID0gZnVuY3Rpb24odGltZSwgZnJhbWUsIG1ldGFEYXRhKSB7XG4gICAgY29uc3QgZnJhbWVTaXplID0gdGhpcy5vdXRGcmFtZS5sZW5ndGg7XG4gICAgc3RhY2tbY291bnRlcl0gPSBmcmFtZTtcblxuICAgIGlmIChjb3VudGVyID09PSAxKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lU2l6ZTsgaSsrKSB7XG4gICAgICAgIHRoaXMub3V0RnJhbWVbaV0gPSBzdGFja1sxXVtpXSAtIHN0YWNrWzBdW2ldO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnRpbWUgPSB0aW1lO1xuXG4gICAgICAvLyByZXNldFxuICAgICAgc3RhY2subGVuZ3RoID0gMDtcbiAgICAgIHRoaXMub3V0cHV0KCk7XG4gICAgfVxuXG4gICAgY291bnRlciA9IChjb3VudGVyICsgMSkgJSAyO1xuICB9XG5cbiAgY29uc3QgbWF4T3B0aW9ucyA9IHtcbiAgICBmcmFtZVNpemU6IDEsXG4gICAgdHlwZTogJ3ZlY3RvcicsXG4gICAgb25Qcm9jZXNzOiBmdW5jdGlvbih0aW1lLCBmcmFtZSwgb3V0RnJhbWUpIHtcbiAgICAgIGxldCBtYXggPSAtSW5maW5pdHk7XG4gICAgICBsZXQgdmFsdWU7XG5cbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gZnJhbWUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgIHZhbHVlID0gZnJhbWVbaV07XG4gICAgICAgIGlmICh2YWx1ZSA+IG1heCkgeyBtYXggPSB2YWx1ZTsgfVxuICAgICAgfVxuXG4gICAgICBvdXRGcmFtZVswXSA9IG1heDtcbiAgICB9XG4gIH07XG5cbiAgY29uc3QgbWF4TUExID0gbmV3IGxmby5vcGVyYXRvcnMuT3BlcmF0b3IobWF4T3B0aW9ucyk7XG4gIGNvbnN0IGJwZk1BMSA9IG5ldyBsZm8uc2lua3MuQnBmKHtcbiAgICBjYW52YXM6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjYW52YXMtMycpLFxuICAgIGR1cmF0aW9uOiA0LFxuICB9KTtcblxuICBjb25zdCBtYXhNQTIgPSBuZXcgbGZvLm9wZXJhdG9ycy5PcGVyYXRvcihtYXhPcHRpb25zKTtcbiAgY29uc3QgYnBmTUEyID0gbmV3IGxmby5zaW5rcy5CcGYoe1xuICAgIGNhbnZhczogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2NhbnZhcy00JyksXG4gICAgZHVyYXRpb246IDQsXG4gIH0pO1xuXG5cbiAgLy8gZ2V0IG1heCB2YWx1ZSBmcm9tIGVhY2ggZnJhbWVzXG4gIGNvbnN0IG1heCA9IG5ldyBsZm8ub3BlcmF0b3JzLk9wZXJhdG9yKG1heE9wdGlvbnMpO1xuXG4gIGNvbnN0IGJwZiA9IG5ldyBsZm8uc2lua3MuQnBmKHtcbiAgICBjYW52YXM6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNjYW52YXMtMicpLFxuICAgIGR1cmF0aW9uOiA0LFxuICB9KTtcblxuICBjb25zdCAkb25zZXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjb25zZXQnKTtcbiAgY29uc3QgJHRpbWVzdGFtcHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjdGltZXN0YW1wcycpO1xuICBjb25zdCB0aHJlc2hvbGQgPSAwLjA0O1xuICBsZXQgYWN0aXZlID0gZmFsc2U7XG5cbiAgLy8gbG9nIGFsbCBuZXcgb25zZXRzXG4gIGNvbnN0IGxvZ2dlciA9IG5ldyBsZm8ub3BlcmF0b3JzLk5vb3AoKTtcbiAgbG9nZ2VyLnByb2Nlc3MgPSBmdW5jdGlvbih0aW1lLCBmcmFtZSkge1xuICAgIGlmIChmcmFtZVswXSA+IHRocmVzaG9sZCkge1xuICAgICAgaWYgKCFhY3RpdmUpIHtcbiAgICAgICAgYWN0aXZlID0gdHJ1ZTtcbiAgICAgICAgJG9uc2V0LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpO1xuICAgICAgICAkdGltZXN0YW1wcy5pbm5lckhUTUwgPSAnPHA+JyArIHRpbWUgKyAnPC9wPicgKyAkdGltZXN0YW1wcy5pbm5lckhUTUw7XG4gICAgICAgIC8vIHVwZGF0ZSBtYXJrZXJzXG4gICAgICAgIG1hcmtlckRhdGEucHVzaCh7IHRpbWUgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGFjdGl2ZSA9IGZhbHNlO1xuICAgICAgJG9uc2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpO1xuICAgIH1cbiAgfVxuXG4gIHNvdXJjZS5jb25uZWN0KGxvbmdNb3ZpbmdBdmVyYWdlKTtcbiAgc291cmNlLmNvbm5lY3Qoc2hvcnRNb3ZpbmdBdmVyYWdlKTtcblxuICBsb25nTW92aW5nQXZlcmFnZS5jb25uZWN0KGRpZmYpO1xuICBzaG9ydE1vdmluZ0F2ZXJhZ2UuY29ubmVjdChkaWZmKTtcblxuICBsb25nTW92aW5nQXZlcmFnZS5jb25uZWN0KG1heE1BMSk7XG4gIG1heE1BMS5jb25uZWN0KGJwZk1BMSk7XG5cbiAgc2hvcnRNb3ZpbmdBdmVyYWdlLmNvbm5lY3QobWF4TUEyKTtcbiAgbWF4TUEyLmNvbm5lY3QoYnBmTUEyKTtcblxuICBkaWZmLmNvbm5lY3QobWF4KTtcbiAgbWF4LmNvbm5lY3QoYnBmKTtcbiAgbWF4LmNvbm5lY3QobG9nZ2VyKTtcblxuICAvLyBVSSBQQVJUXG4gIGNvbnN0IGRpc3BsYXllZER1cmF0aW9uID0gMTA7XG4gIGNvbnN0IHdpZHRoID0gODAwO1xuICBjb25zdCBwaXhlbHNQZXJTZWNvbmQgPSB3aWR0aCAvIGRpc3BsYXllZER1cmF0aW9uO1xuXG4gIGNvbnN0IHRpbWVsaW5lID0gbmV3IHVpLmNvcmUuVGltZWxpbmUocGl4ZWxzUGVyU2Vjb25kLCB3aWR0aCk7XG4gIHRpbWVsaW5lLmNyZWF0ZVRyYWNrKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNheGlzJyksIDE2LCAnYXhpcycpO1xuICB0aW1lbGluZS5jcmVhdGVUcmFjayhkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjdHJhY2snKSwgMjAwLCAnbWFpbicpO1xuXG4gIGNvbnN0IGF4aXMgPSBuZXcgdWkuaGVscGVycy5UaW1lQXhpc0xheWVyKCk7XG4gIHRpbWVsaW5lLmFkZExheWVyKGF4aXMsICdheGlzJywgJ2RlZmF1bHQnLCB0cnVlKTtcblxuICBjb25zdCB3YXZlZm9ybUxheWVyID0gbmV3IHVpLmNvcmUuTGF5ZXIoJ2VudGl0eScsIHdhdmVmb3JtRGF0YSwge1xuICAgIGhlaWdodDogMjAwLFxuICAgIHNhbXBsZVJhdGU6IGN0eC5zYW1wbGVSYXRlLFxuICAgIHlEb21haW46IFstMSwgMV0sXG4gIH0pO1xuXG4gIHdhdmVmb3JtTGF5ZXIuc2V0VGltZUNvbnRleHQobmV3IHVpLmNvcmUuTGF5ZXJUaW1lQ29udGV4dCh0aW1lbGluZS50aW1lQ29udGV4dCkpO1xuICB3YXZlZm9ybUxheWVyLmNvbmZpZ3VyZVNoYXBlKHVpLnNoYXBlcy5XYXZlZm9ybSwge1xuICAgIHk6IChkKSA9PiB7IHJldHVybiBkOyB9XG4gIH0sIHtcbiAgICBjb2xvcjogJ3N0ZWVsYmx1ZScsXG4gIH0pO1xuXG4gIGNvbnN0IG1hcmtlckxheWVyID0gbmV3IHVpLmhlbHBlcnMuTWFya2VyTGF5ZXIobWFya2VyRGF0YSwge1xuICAgIGhlaWdodDogMjAwLFxuICAgIGRpc3BsYXlIYW5kbGVyczogZmFsc2UsXG4gIH0sIHtcbiAgICBjb2xvcjogKCkgPT4geyByZXR1cm4gJ3JlZCc7IH0sXG4gICAgeDogKGQpID0+IHsgcmV0dXJuIGQudGltZTsgfSxcbiAgfSk7XG5cbiAgdGltZWxpbmUuYWRkTGF5ZXIod2F2ZWZvcm1MYXllciwgJ21haW4nKTtcbiAgdGltZWxpbmUuYWRkTGF5ZXIobWFya2VyTGF5ZXIsICdtYWluJyk7XG5cbiAgdGltZWxpbmUuc3RhdGUgPSBuZXcgdWkuc3RhdGVzLkNlbnRlcmVkWm9vbVN0YXRlKHRpbWVsaW5lKTtcblxuICB0aW1lbGluZS50cmFja3MucmVuZGVyKCk7XG5cbiAgLy8gbGZvIHRvIGFwcGVuZCB2YWx1ZXMgdG8gdGhlIGRhdGEgb2YgdGhlIHdhdmVmb3JtXG4gIGNvbnN0IGFwcGVuZGVyID0gbmV3IGxmby5vcGVyYXRvcnMuTm9vcCgpO1xuICBhcHBlbmRlci5wcm9jZXNzID0gZnVuY3Rpb24odGltZSwgZnJhbWUpIHtcbiAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseSh3YXZlZm9ybURhdGEsIEFycmF5LmZyb20oZnJhbWUudmFsdWVzKCkpKTtcbiAgfVxuXG4gIHNvdXJjZS5jb25uZWN0KGFwcGVuZGVyKTtcblxuICBsZXQgckFGSWQ7XG4gIC8vIHVwZGF0ZSB3YXZlZm9ybUxheWVyXG4gIGZ1bmN0aW9uIGxvb3AoKSB7XG4gICAgY29uc3QgYnVmZmVyRHVyYXRpb24gPSB3YXZlZm9ybURhdGEubGVuZ3RoIC8gY3R4LnNhbXBsZVJhdGU7XG5cbiAgICBpZiAoYnVmZmVyRHVyYXRpb24gPiBkaXNwbGF5ZWREdXJhdGlvbikge1xuICAgICAgY29uc3QgZGVjYXlUaW1lID0gYnVmZmVyRHVyYXRpb24gLSBkaXNwbGF5ZWREdXJhdGlvbjtcblxuICAgICAgdGltZWxpbmUub2Zmc2V0ID0gLWRlY2F5VGltZTtcbiAgICAgIHdhdmVmb3JtTGF5ZXIuZHVyYXRpb24gPSBidWZmZXJEdXJhdGlvbjtcbiAgICAgIG1hcmtlckxheWVyLmR1cmF0aW9uID0gYnVmZmVyRHVyYXRpb247XG4gICAgfVxuXG4gICAgdGltZWxpbmUudHJhY2tzLnJlbmRlcigpO1xuICAgIHRpbWVsaW5lLnRyYWNrcy51cGRhdGUoKTtcblxuICAgIHJBRklkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGxvb3ApO1xuICB9O1xuXG4gIGZ1bmN0aW9uIHJlc2V0KCkge1xuICAgIHRpbWVsaW5lLm9mZnNldCA9IDA7XG4gICAgdGltZWxpbmUuem9vbSA9IDE7XG4gICAgd2F2ZWZvcm1MYXllci5kdXJhdGlvbiA9IGRpc3BsYXllZER1cmF0aW9uO1xuICAgIG1hcmtlckxheWVyLmR1cmF0aW9uID0gZGlzcGxheWVkRHVyYXRpb247XG4gICAgd2F2ZWZvcm1EYXRhLmxlbmd0aCA9IDA7XG4gICAgbWFya2VyRGF0YS5sZW5ndGggPSAwO1xuICAgICR0aW1lc3RhbXBzLmlubmVySFRNTCA9ICcnO1xuICB9XG5cbiAgLy8gY29udHJvbHNcbiAgY29uc3QgJHN0YXJ0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3N0YXJ0Jyk7XG4gICRzdGFydC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGUpIHtcbiAgICAvLyByZXNldCB0aW1lbGluZVxuICAgIHJlc2V0KCk7XG4gICAgbG9vcCgpO1xuXG4gICAgc291cmNlLnN0YXJ0KCk7XG4gIH0pO1xuXG4gIGNvbnN0ICRzdG9wID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3N0b3AnKTtcbiAgJHN0b3AuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKSB7XG4gICAgc291cmNlLnN0b3AoKTtcbiAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyQUZJZCk7XG4gIH0pO1xufVxuXG5uYXZpZ2F0b3IuZ2V0VXNlck1lZGlhKHsgYXVkaW86IHRydWUgfSwgcnVuLCBmdW5jdGlvbihlcnIpIHtcbiAgY29uc29sZS5lcnJvcihlcnIuc3RhY2spO1xufSk7XG5cblxuXG5cblxuXG5cbiJdfQ==